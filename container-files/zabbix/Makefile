MAKEFLAGS = -j 1
CONTAINER_RUNTIME = podman
BUILD_ARGS := --rm
REBUILD_ARGS := --no-cache --squash --rm
RUN_ARGS := --rm -it
RUN_CMD := bash
USER_NAME := $(shell whoami)
REGISTRY := registry.local
BUILD_FILES = .web-pgsql .server-pgsql
TAG := 6.0
DB = pgsql
ZABBIX_SERVER_IMAGE_NAME := zabbix-server-$(DB)
ZABBIX_SERVER_IMAGE_TAG := $(REGISTRY)/$(USER_NAME)/$(ZABBIX_SERVER_IMAGE_NAME):$(TAG)
ZABBIX_WEB_IMAGE_NAME := zabbix-web-$(DB)
ZABBIX_WEB_IMAGE_TAG := $(REGISTRY)/$(USER_NAME)/$(ZABBIX_WEB_IMAGE_NAME):$(TAG)

ZABBIX_DB_IMAGE_NAME := postgresql
ZABBIX_DB_IMAGE_TAG := 16
ZABBIX_DB_IMAGE := $(REGISTRY)/$(USER_NAME)/$(ZABBIX_DB_IMAGE_NAME):$(ZABBIX_DB_IMAGE_TAG)
PGSQL_START_ARGS := -e "POSTGRES_PASSWORD=123" -e "POSTGRES_HOST_AUTH_METHOD=scram-sha-256" -e "POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256"
POD_NAME = zabbix-test

.PHONY: build
build: $(BUILD_FILES)

.server-pgsql: ./server-pgsql/*
	$(CONTAINER_RUNTIME) build $(BUILD_ARGS) -t $(ZABBIX_SERVER_IMAGE_TAG) ./server-pgsql

.web-pgsql: ./web-pgsql/*
	$(CONTAINER_RUNTIME) build $(BUILD_ARGS) -t $(ZABBIX_WEB_IMAGE_TAG) ./web-pgsql


.PHONY: run
run:
	$(CONTAINER_RUNTIME) run $(RUN_ARGS) $(ZABBIX_SERVER_IMAGE_TAG) $(RUN_CMD)
	$(CONTAINER_RUNTIME) run $(RUN_ARGS) $(ZABBIX_WEB_IMAGE_TAG) $(RUN_CMD)

.PHONY: start
start:
	$(CONTAINER_RUNTIME) run -d -p 10051:10051 --init --name $(ZABBIX_SERVER_IMAGE_NAME) $(ZABBIX_SERVER_IMAGE_TAG)
	$(CONTAINER_RUNTIME) run -d -p 8080:8080 -p 8443:8443 --name $(ZABBIX_WEB_IMAGE_NAME) $(ZABBIX_WEB_IMAGE_TAG)

.PHONY: stop
stop:
	$(CONTAINER_RUNTIME) rm -fi $(ZABBIX_SERVER_IMAGE_NAME) $(ZABBIX_WEB_IMAGE_NAME)

.PHONY: pod-start
pod-start:
	$(CONTAINER_RUNTIME) pod create --name $(POD_NAME) -p 80:8080 -p 5432:5432 -p 10051:10051
	$(CONTAINER_RUNTIME) run $(PGSQL_START_ARGS) -p 5432:5432 -d --name $(ZABBIX_DB_IMAGE_NAME) --pod=$(POD_NAME) $(ZABBIX_DB_IMAGE)
	$(CONTAINER_RUNTIME) run -d -p 10051:10051 --init --name $(ZABBIX_SERVER_IMAGE_NAME) --pod=$(POD_NAME) $(ZABBIX_SERVER_IMAGE_TAG)
	$(CONTAINER_RUNTIME) run -d -p 8080:8080 -p 8443:8443 --name $(ZABBIX_WEB_IMAGE_NAME) --pod=$(POD_NAME) $(ZABBIX_WEB_IMAGE_TAG)

.PHONY: pod-stop
pod-stop:
	$(CONTAINER_RUNTIME) pod rm -f $(POD_NAME)

.PHONY: clean
clean: $(BUILD_FILES)
	$(CONTAINER_RUNTIME) rmi $(ZABBIX_SERVER_IMAGE_TAG) $(ZABBIX_WEB_IMAGE_TAG)
# rm ./server-pgsql ./web-pgsql
# $(CONTAINER_RUNTIME) rmi $(ZABBIX_SERVER_IMAGE_TAG) $(ZABBIX_WEB_IMAGE_TAG)
	